<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug QR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <h1>Debug QR Test</h1>
    
    <div>
        <h2>Generated QR Code:</h2>
        <canvas id="qrCanvas" width="200" height="200"></canvas>
    </div>
    
    <div>
        <h2>Test Results:</h2>
        <div id="results"></div>
    </div>
    
    <div>
        <h2>Canvas Debug:</h2>
        <canvas id="debugCanvas" width="200" height="200" style="border: 1px solid #ccc;"></canvas>
    </div>

    <script>
        async function runTest() {
            const results = document.getElementById('results');
            const qrCanvas = document.getElementById('qrCanvas');
            const debugCanvas = document.getElementById('debugCanvas');
            const debugCtx = debugCanvas.getContext('2d');
            
            try {
                // Generate a simple QR code
                const testData = "Hello World";
                await QRCode.toCanvas(qrCanvas, testData, { width: 200 });
                
                results.innerHTML += `<p>‚úÖ QR Code generated with data: "${testData}"</p>`;
                
                // Get image data from the generated QR code
                const ctx = qrCanvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                
                results.innerHTML += `<p>üìä ImageData: ${imageData.width}x${imageData.height}, ${imageData.data.length} bytes</p>`;
                
                // Copy to debug canvas for visual inspection
                debugCtx.putImageData(imageData, 0, 0);
                
                // Try to read the QR code with different options
                let qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (qrCode) {
                    results.innerHTML += `<p>‚úÖ QR Code detected (no invert): "${qrCode.data}"</p>`;
                } else {
                    results.innerHTML += `<p>‚ùå QR Code NOT detected (no invert)</p>`;
                    
                    // Try with inversion
                    qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "onlyInvert",
                    });
                    
                    if (qrCode) {
                        results.innerHTML += `<p>‚úÖ QR Code detected (with invert): "${qrCode.data}"</p>`;
                    } else {
                        results.innerHTML += `<p>‚ùå QR Code NOT detected (with invert)</p>`;
                        
                        // Try with both
                        qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        
                        if (qrCode) {
                            results.innerHTML += `<p>‚úÖ QR Code detected (attempt both): "${qrCode.data}"</p>`;
                        } else {
                            results.innerHTML += `<p>‚ùå QR Code NOT detected (attempt both)</p>`;
                        }
                    }
                }
                
                // Test with a file upload simulation
                results.innerHTML += `<h3>File Upload Simulation:</h3>`;
                
                // Convert canvas to blob and then process like a file
                qrCanvas.toBlob(async (blob) => {
                    try {
                        const file = new File([blob], 'test-qr.png', { type: 'image/png' });
                        results.innerHTML += `<p>üìÅ Created file: ${file.name}, size: ${file.size} bytes</p>`;
                        
                        // Process like the main app does
                        const imageData2 = await fileToImageData(file);
                        results.innerHTML += `<p>üìä File ImageData: ${imageData2.width}x${imageData2.height}, ${imageData2.data.length} bytes</p>`;
                        
                        const qrCode2 = jsQR(imageData2.data, imageData2.width, imageData2.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        
                        if (qrCode2) {
                            results.innerHTML += `<p>‚úÖ File QR Code detected: "${qrCode2.data}"</p>`;
                        } else {
                            results.innerHTML += `<p>‚ùå File QR Code NOT detected</p>`;
                        }
                        
                    } catch (error) {
                        results.innerHTML += `<p>‚ùå File processing error: ${error.message}</p>`;
                    }
                }, 'image/png');
                
            } catch (error) {
                results.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
            }
        }
        
        function fileToImageData(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    reject(new Error('File must be an image'));
                    return;
                }
                
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    try {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        URL.revokeObjectURL(img.src);
                        resolve(imageData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = () => {
                    URL.revokeObjectURL(img.src);
                    reject(new Error('Failed to load image'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Run test when page loads
        window.addEventListener('load', runTest);
    </script>
</body>
</html>