<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSQRScanner - Grupo AreLuna</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">JSQRScanner</h1>
            <p class="text-gray-600">Grupo AreLuna - Scanner de QR Codes em Tempo Real</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Camera Controls -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-center mb-4">
                    <button id="startCamera" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        Iniciar C√¢mera
                    </button>
                    <button id="stopCamera" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition-colors" disabled>
                        Parar C√¢mera
                    </button>
                    <select id="cameraSelect" class="border border-gray-300 rounded-lg px-4 py-3 bg-white">
                        <option value="">Selecionar C√¢mera</option>
                    </select>
                </div>

                <!-- Camera Feed -->
                <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 400px;">
                    <video id="video" class="w-full h-full object-cover" autoplay muted playsinline style="display: none;"></video>
                    <canvas id="canvas" class="absolute top-0 left-0 w-full h-full" style="display: none;"></canvas>
                    <div id="cameraPlaceholder" class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üì∑</div>
                            <p id="scanStatus" class="text-lg">Clique em "Iniciar C√¢mera" para come√ßar</p>
                        </div>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Imagem</label>
                    <input type="file" id="fileInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="bg-white rounded-2xl shadow-lg p-6 mb-6" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Resultado</h3>
                <div id="successResult" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-green-800 font-medium mb-2">‚úÖ QR Code Decodificado</h4>
                        <div class="bg-white rounded border p-3 mb-3">
                            <code id="qrContent" class="text-sm text-gray-800 break-all"></code>
                        </div>
                        <div class="flex gap-2">
                            <button id="copyBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">Copiar</button>
                            <button id="downloadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">Download</button>
                        </div>
                    </div>
                </div>
                <div id="errorResult" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="text-red-800 font-medium mb-2">‚ùå Erro na Decodifica√ß√£o</h4>
                        <p id="errorMessage" class="text-red-700 text-sm"></p>
                    </div>
                </div>
            </div>

            <!-- Invoice Processing Interface -->
            <div id="invoiceProcessing" class="bg-white rounded-2xl shadow-lg p-6 mb-6" style="display: none;">
                <!-- Visual Prompt Header -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center mb-3">
                        <div class="bg-green-500 text-white rounded-full p-2 mr-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Fatura decodificada com sucesso!</h3>
                    </div>
                    <p class="text-gray-700 mb-4">
                        Pretende lan√ßar esta fatura no sistema e acionar integra√ß√µes autom√°ticas? 
                        Selecione as a√ß√µes desejadas abaixo ou preencha campos adicionais conforme necess√°rio:
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üí≥</span> Efetuar pagamento via banco
                        </div>
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üìä</span> Registrar IVA recolhido
                        </div>
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üè∑Ô∏è</span> Categorizar fatura
                        </div>
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üìù</span> Lan√ßar em contas a pagar
                        </div>
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üìé</span> Anexar comprovativo
                        </div>
                        <div class="flex items-center text-gray-600">
                            <span class="mr-2">üîî</span> Criar alerta de vencimento
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üßæ Dados da Fatura</h3>
                    <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        Fatura decodificada!
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-blue-800 font-medium mb-2">
                        üéØ Pretende lan√ßar esta fatura no sistema e acionar integra√ß√µes autom√°ticas?
                    </p>
                    <p class="text-blue-700 text-sm">
                        Selecione as a√ß√µes desejadas abaixo ou preencha campos adicionais conforme necess√°rio:
                    </p>
                </div>

                <!-- Invoice Details Form -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Left Column - Invoice Data -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">üìã Dados da Fatura</h4>
                        
                        <!-- Se√ß√£o A-E: Identifica√ß√£o -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="mr-2">üè¢</span> Identifica√ß√£o das Partes
                            </h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">A - NIF do Emitente</label>
                                    <input type="text" id="nifEmitente" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Pessoa singular ou empresa que emitiu a fatura</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">B - NIF do Adquirente</label>
                                    <input type="text" id="nifAdquirente" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Instituto AreLuna (cliente)</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mt-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">C - Pa√≠s do Emitente</label>
                                    <input type="text" id="paisEmitente" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">D - Pa√≠s do Adquirente</label>
                                    <input type="text" id="paisAdquirente" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-red-500 mt-1" id="paisAdquirenteWarning" style="display: none;">‚ö†Ô∏è N√£o √© um pa√≠s ISO v√°lido</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">E - Tipo de Adquirente</label>
                                    <input type="text" id="tipoAdquirente" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">N = N√£o residente</div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o F-H: Documento -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="mr-2">üìÑ</span> Dados do Documento
                            </h5>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">F - Data do Documento</label>
                                    <input type="date" id="dataFatura" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">G - S√©rie e N√∫mero</label>
                                    <input type="text" id="numeroDocumento" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Identificador √∫nico da fatura</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">H - C√≥digo do Documento</label>
                                    <input type="text" id="codigoDocumento" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Valor gen√©rico ou omitido</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Documento</label>
                                    <input type="text" id="tipoDocumento" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-medium" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">I1 - Moeda</label>
                                    <input type="text" id="moeda" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-red-500 mt-1" id="moedaWarning" style="display: none;">‚ö†Ô∏è Erro - o correto seria EUR</div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o I2-I8: Valores Base -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="mr-2">üí∞</span> Valores e IVA
                            </h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">I2-I6 - Valores de IVA por Taxas</label>
                                    <input type="text" id="valoresIVATaxas" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Nenhum valor declarado nas taxas habituais</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">I7 - Valor Base Isento ou Sujeito</label>
                                    <input type="text" id="baseTributavel" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Valor da base tribut√°vel</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mt-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">I8 - Valor do IVA Calculado</label>
                                    <input type="text" id="iva" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">IVA sobre a base</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">N - Total de IVA</label>
                                    <input type="text" id="totalIVA" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">Confirma o valor anterior</div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">O - Total com IVA</label>
                                <input type="text" id="total" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-semibold bg-green-50" readonly>
                                <div class="text-xs text-gray-500 mt-1">Soma: 12.20 + 2.80</div>
                            </div>
                        </div>

                        <!-- Se√ß√£o Q-R: C√≥digos e Motivos -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                                <span class="mr-2">‚ö†Ô∏è</span> C√≥digos de Isen√ß√£o e Motivos
                            </h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Q - C√≥digo de Isen√ß√£o</label>
                                    <input type="text" id="codigoIsencao" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-red-500 mt-1" id="codigoIsencaoWarning" style="display: none;">‚ö†Ô∏è Parece incorreto - c√≥digos v√°lidos s√£o padronizados</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">R - Motivo de Isen√ß√£o (c√≥digo AT)</label>
                                    <input type="text" id="motivoIsencao" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" readonly>
                                    <div class="text-xs text-gray-500 mt-1">M88 = Isento - outras situa√ß√µes n√£o previstas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Fields -->
                        <div class="space-y-3 pt-4 border-t">
                            <h5 class="font-medium text-gray-700">‚úèÔ∏è Campos Adicionais</h5>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o/Observa√ß√µes</label>
                                <textarea id="descricao" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Adicione uma descri√ß√£o ou observa√ß√µes sobre esta fatura..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Refer√™ncia Interna</label>
                                <input type="text" id="referenciaInterna" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Ex: PO-2024-001, Projeto X, etc.">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Centro de Custo</label>
                                <select id="centroCusto" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">Selecionar centro de custo...</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="comercial">Comercial</option>
                                    <option value="producao">Produ√ß√£o</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="ti">Tecnologia da Informa√ß√£o</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Actions -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">‚ö° A√ß√µes Autom√°ticas</h4>
                        
                        <!-- Banking Integration -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="efetuarPagamento" class="mr-2">
                                <label for="efetuarPagamento" class="font-medium text-gray-800">üè¶ Efetuar pagamento via banco</label>
                            </div>
                            <div id="bankingOptions" class="ml-6 space-y-2" style="display: none;">
                                <select id="bancoSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">Selecionar institui√ß√£o banc√°ria...</option>
                                    <option value="caixa">Caixa Geral de Dep√≥sitos</option>
                                    <option value="bcp">Millennium BCP</option>
                                    <option value="santander">Santander</option>
                                    <option value="bes">Novo Banco</option>
                                    <option value="bpi">Banco BPI</option>
                                    <option value="montepio">Montepio</option>
                                </select>
                                <input type="text" id="contaBancaria" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="N√∫mero da conta (opcional)">
                                <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                                    <p class="font-medium text-blue-800 mb-2">üí° Detalhes pr√©-preenchidos:</p>
                                    <div class="space-y-1 text-blue-700">
                                        <div>Benefici√°rio: <span id="beneficiarioPreenchido" class="font-medium">-</span></div>
                                        <div>IBAN: <span id="ibanPreenchido" class="font-medium">-</span></div>
                                        <div>Valor: <span id="valorPreenchido" class="font-medium">-</span></div>
                                        <div>Refer√™ncia: <span id="referenciaPreenchida" class="font-medium">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VAT Control -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="registrarIVA" class="mr-2">
                                <label for="registrarIVA" class="font-medium text-gray-800">üìä Registrar IVA recolhido pela adquirente</label>
                            </div>
                            <div id="ivaOptions" class="ml-6 space-y-2" style="display: none;">
                                <select id="regimeIVA" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">Selecionar regime de IVA...</option>
                                    <option value="normal">Regime Normal</option>
                                    <option value="simplificado">Regime Simplificado</option>
                                    <option value="isento">Isento de IVA</option>
                                    <option value="rc">Reverse Charge</option>
                                </select>
                                <div class="text-xs text-gray-600">
                                    IVA ser√° registrado automaticamente conforme o regime selecionado
                                </div>
                            </div>
                        </div>

                        <!-- Accounting Categories -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="categorizarFatura" class="mr-2">
                                <label for="categorizarFatura" class="font-medium text-gray-800">üè∑Ô∏è Categorizar fatura</label>
                            </div>
                            <div id="categoryOptions" class="ml-6 space-y-2" style="display: none;">
                                <select id="categoriaContabil" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">Selecionar categoria cont√°bil...</option>
                                    <option value="fornecimentos-servicos-externos">Fornecimentos e Servi√ßos Externos</option>
                                    <option value="mercadorias">Mercadorias</option>
                                    <option value="materias-primas">Mat√©rias-primas</option>
                                    <option value="equipamentos">Equipamentos</option>
                                    <option value="servicos-profissionais">Servi√ßos Profissionais</option>
                                    <option value="marketing-publicidade">Marketing e Publicidade</option>
                                    <option value="viagens-deslocacoes">Viagens e Desloca√ß√µes</option>
                                    <option value="comunicacoes">Comunica√ß√µes</option>
                                    <option value="seguros">Seguros</option>
                                    <option value="outros">Outros</option>
                                </select>
                                <input type="text" id="tagsPersonalizadas" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" placeholder="Tags personalizadas (separadas por v√≠rgula)">
                                <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm">
                                    <p class="font-medium text-yellow-800 mb-1">üí° Sugest√£o autom√°tica:</p>
                                    <p id="sugestaoCategoria" class="text-yellow-700">Categoria ser√° sugerida com base no valor e fornecedor</p>
                                </div>
                            </div>
                        </div>

                        <!-- Accounts Payable -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="contasPagar" class="mr-2">
                                <label for="contasPagar" class="font-medium text-gray-800">üìù Lan√ßar documento em contas a pagar</label>
                            </div>
                            <div id="payableOptions" class="ml-6 space-y-2" style="display: none;">
                                <input type="date" id="dataVencimento" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <label class="text-xs text-gray-600">Data de vencimento</label>
                            </div>
                        </div>

                        <!-- Payment Attachment -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="anexarComprovativo" class="mr-2">
                                <label for="anexarComprovativo" class="font-medium text-gray-800">üìé Anexar comprovativo ap√≥s pagamento</label>
                            </div>
                            <div class="ml-6 text-xs text-gray-600">
                                Sistema ir√° solicitar anexo do comprovativo ap√≥s confirma√ß√£o do pagamento
                            </div>
                        </div>

                        <!-- Notifications -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="criarAlerta" class="mr-2">
                                <label for="criarAlerta" class="font-medium text-gray-800">üîî Criar alerta de vencimento/recibo</label>
                            </div>
                            <div id="alertOptions" class="ml-6 space-y-3" style="display: none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Alerta</label>
                                    <select id="tipoAlerta" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="vencimento">Alerta de vencimento</option>
                                        <option value="reconciliacao">Alerta de reconcilia√ß√£o</option>
                                        <option value="pagamento">Alerta de pagamento</option>
                                        <option value="ambos">Todos os alertas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Anteced√™ncia</label>
                                    <select id="antecedenciaAlerta" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="1">1 dia antes</option>
                                        <option value="3">3 dias antes</option>
                                        <option value="7">7 dias antes</option>
                                        <option value="15">15 dias antes</option>
                                        <option value="30">30 dias antes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Notifica√ß√£o</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="alertEmail" class="mr-2" checked>
                                            <span class="text-sm">üìß Email</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="alertSMS" class="mr-2">
                                            <span class="text-sm">üì± SMS</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="alertPush" class="mr-2" checked>
                                            <span class="text-sm">üîî Notifica√ß√£o Push</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="alertPreview" class="bg-blue-50 border border-blue-200 rounded-md p-3 text-sm">
                                    <div class="font-medium text-blue-800 mb-1">Preview do Alerta:</div>
                                    <div id="alertPreviewText" class="text-blue-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between items-center pt-6 border-t">
                    <button id="cancelProcessing" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                        Cancelar
                    </button>
                    <div class="flex gap-3">
                        <button id="saveAsDraft" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg">
                            üíæ Salvar como Rascunho
                        </button>
                        <button id="processInvoice" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">
                            üöÄ Processar Fatura
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Estat√≠sticas do Scanner</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div id="scanCount" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-gray-600">QR Codes Detectados</div>
                    </div>
                    <div class="text-center">
                        <div id="successCount" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">Sucessos</div>
                    </div>
                    <div class="text-center">
                        <div id="errorCount" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-sm text-gray-600">Erros</div>
                    </div>
                    <div class="text-center">
                        <div id="avgTime" class="text-2xl font-bold text-purple-600">0ms</div>
                        <div class="text-sm text-gray-600">Tempo M√©dio</div>
                    </div>
                </div>
            </div>

            <!-- Debug Log -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Debug Log & System Analysis</h2>
                    <div class="flex gap-2">
                        <button id="clearLog" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">Limpar Log</button>
                        <button id="exportLog" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">Exportar Log</button>
                        <button id="generateReport" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">Gerar Relat√≥rio</button>
                    </div>
                </div>
                
                <!-- Log Filters -->
                <div class="mb-4 flex flex-wrap gap-2">
                    <button class="log-filter active bg-gray-800 text-white px-3 py-1 rounded text-xs" data-level="all">Todos</button>
                    <button class="log-filter bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs" data-level="info">Info</button>
                    <button class="log-filter bg-green-200 text-green-700 px-3 py-1 rounded text-xs" data-level="success">Sucesso</button>
                    <button class="log-filter bg-yellow-200 text-yellow-700 px-3 py-1 rounded text-xs" data-level="warning">Avisos</button>
                    <button class="log-filter bg-red-200 text-red-700 px-3 py-1 rounded text-xs" data-level="error">Erros</button>
                    <button class="log-filter bg-blue-200 text-blue-700 px-3 py-1 rounded text-xs" data-level="debug">Debug</button>
                </div>
                
                <div id="debugLog" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm border">
                    <div class="text-gray-600 log-entry" data-level="info" data-timestamp="2024-01-01T00:00:00.000Z">
                        <span class="timestamp">[00:00:00.000]</span> 
                        <span class="level">[INFO]</span> 
                        <span class="message">Debug log iniciado - QR Code Reader Service v2.0</span>
                        <span class="context" data-context='{"version":"2.0","browser":"Chrome","userAgent":"Mozilla/5.0"}'></span>
                    </div>
                    <div class="text-gray-600 log-entry" data-level="info" data-timestamp="2024-01-01T00:00:00.100Z">
                        <span class="timestamp">[00:00:00.100]</span> 
                        <span class="level">[INFO]</span> 
                        <span class="message">Sistema pronto para processar imagens</span>
                        <span class="context" data-context='{"capabilities":["camera","qr","processing"]}'></span>
                    </div>
                </div>
                
                <!-- Enhanced System Status -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <span class="text-sm text-green-600 font-medium">Status do Sistema</span>
                        <div id="systemStatus" class="text-green-700 font-bold">‚úì Online</div>
                        <div class="text-xs text-green-600 mt-1" id="uptime">Uptime: 00:00:00</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <span class="text-sm text-blue-600 font-medium">√öltima Opera√ß√£o</span>
                        <div id="lastOperation" class="text-blue-700 font-bold">Aguardando...</div>
                        <div class="text-xs text-blue-600 mt-1" id="lastOperationTime">--:--:--</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <span class="text-sm text-purple-600 font-medium">Performance</span>
                        <div id="performanceMetrics" class="text-purple-700 font-bold">CPU: 0% | RAM: 0MB</div>
                        <div class="text-xs text-purple-600 mt-1" id="processingTime">Tempo m√©dio: 0ms</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                        <span class="text-sm text-orange-600 font-medium">Estat√≠sticas</span>
                        <div id="sessionStats" class="text-orange-700 font-bold">QRs: 0 | Erros: 0</div>
                        <div class="text-xs text-orange-600 mt-1" id="successRate">Taxa sucesso: 100%</div>
                    </div>
                </div>

                <!-- Technical Details for LLM Analysis -->
                <div class="mt-4">
                    <details class="bg-gray-100 rounded-lg">
                        <summary class="p-3 cursor-pointer font-medium text-gray-700 hover:bg-gray-200 rounded-lg">
                            üîß Detalhes T√©cnicos para An√°lise (LLM/Ferramentas)
                        </summary>
                        <div class="p-4 border-t bg-white">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Environment Info</h4>
                                    <pre id="envInfo" class="bg-gray-50 p-2 rounded text-xs overflow-auto">
{
  "userAgent": "Loading...",
  "platform": "Loading...",
  "language": "Loading...",
  "cookieEnabled": false,
  "onLine": true,
  "hardwareConcurrency": 0,
  "deviceMemory": 0
}
                                    </pre>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Camera Capabilities</h4>
                                    <pre id="cameraInfo" class="bg-gray-50 p-2 rounded text-xs overflow-auto">
{
  "available": false,
  "permissions": "unknown",
  "constraints": {},
  "activeStream": null,
  "supportedFormats": []
}
                                    </pre>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-2">QR Processing Stats</h4>
                                    <pre id="qrStats" class="bg-gray-50 p-2 rounded text-xs overflow-auto">
{
  "totalScanned": 0,
  "successfulReads": 0,
  "failedReads": 0,
  "averageProcessingTime": 0,
  "lastQRData": null,
  "errorPatterns": []
}
                                    </pre>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-2">Error Analysis</h4>
                                    <pre id="errorAnalysis" class="bg-gray-50 p-2 rounded text-xs overflow-auto">
{
  "recentErrors": [],
  "errorFrequency": {},
  "criticalIssues": [],
  "suggestedFixes": []
}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <!-- JSQRScanner JavaScript -->
    <script>
        class JSQRScanner {
            constructor() {
                this.isScanning = false;
                this.stream = null;
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.scanInterval = null;
                this.stats = {
                    detected: 0,
                    success: 0,
                    errors: 0,
                    totalTime: 0,
                    scanCount: 0
                };
                
                this.initializeElements();
                this.bindEvents();
                this.getCameraDevices();
                this.log('Sistema pronto para processar imagens');
            }

            initializeElements() {
                // Set canvas size
                this.canvas.width = 640;
                this.canvas.height = 480;
            }

            async getCameraDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.innerHTML = '<option value="">Selecionar C√¢mera</option>';
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `C√¢mera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    if (videoDevices.length > 0) {
                        this.log(`${videoDevices.length} c√¢mera(s) detectada(s)`);
                    }
                } catch (error) {
                    this.log(`Erro ao listar c√¢meras: ${error.message}`, 'error');
                }
            }

            bindEvents() {
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCamera').addEventListener('click', () => this.stopCamera());
                document.getElementById('cameraSelect').addEventListener('change', (e) => this.switchCamera(e.target.value));
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                document.getElementById('clearLog').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLog').addEventListener('click', () => this.exportLog());
                document.getElementById('generateReport').addEventListener('click', () => this.generateDebugReport());
                
                // Debug log filter buttons
                document.querySelectorAll('.log-filter').forEach(button => {
                    button.addEventListener('click', (e) => this.filterLogs(e.target.dataset.level));
                });
                
                const copyBtn = document.getElementById('copyBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                if (copyBtn) copyBtn.addEventListener('click', () => this.copyToClipboard());
                if (downloadBtn) downloadBtn.addEventListener('click', () => this.downloadResult());
                
                // Invoice Processing Events
                this.bindInvoiceProcessingEvents();
            }

            bindInvoiceProcessingEvents() {
                // Checkbox toggles for showing/hiding options
                document.getElementById('efetuarPagamento').addEventListener('change', (e) => {
                    document.getElementById('bankingOptions').style.display = e.target.checked ? 'block' : 'none';
                });

                document.getElementById('registrarIVA').addEventListener('change', (e) => {
                    document.getElementById('ivaOptions').style.display = e.target.checked ? 'block' : 'none';
                });

                document.getElementById('categorizarFatura').addEventListener('change', (e) => {
                    document.getElementById('categoryOptions').style.display = e.target.checked ? 'block' : 'none';
                });

                document.getElementById('contasPagar').addEventListener('change', (e) => {
                    document.getElementById('payableOptions').style.display = e.target.checked ? 'block' : 'none';
                });

                document.getElementById('criarAlerta').addEventListener('change', (e) => {
                    document.getElementById('alertOptions').style.display = e.target.checked ? 'block' : 'none';
                    if (e.target.checked) {
                        this.updateAlertPreview();
                    }
                });

                // Add event listeners for alert preview updates
                ['tipoAlerta', 'antecedenciaAlerta', 'alertEmail', 'alertSMS', 'alertPush'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.updateAlertPreview());
                    }
                });

                // Action buttons
                document.getElementById('cancelProcessing').addEventListener('click', () => this.cancelInvoiceProcessing());
                document.getElementById('saveAsDraft').addEventListener('click', () => this.saveInvoiceAsDraft());
                document.getElementById('processInvoice').addEventListener('click', () => this.processInvoiceData());
            }

            async startCamera() {
                try {
                    this.log('Iniciando c√¢mera...');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    const deviceId = cameraSelect.value;
                    
                    const constraints = {
                        video: deviceId ? { deviceId: { exact: deviceId } } : true,
                        audio: false
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    await this.video.play();
                    
                    this.isScanning = true;
                    document.getElementById('startCamera').disabled = true;
                    document.getElementById('stopCamera').disabled = false;
                    document.getElementById('scanStatus').textContent = 'Escaneando...';
                    document.getElementById('scanStatus').className = 'text-lg text-green-600 font-medium';
                    
                    // Show video, hide placeholder
                    this.video.style.display = 'block';
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    
                    this.scanInterval = setInterval(() => this.scanFrame(), 100);
                    this.log('C√¢mera iniciada com sucesso', 'success');
                } catch (error) {
                    this.log(`Erro ao iniciar c√¢mera: ${error.message}`, 'error');
                }
            }

            stopCamera() {
                this.isScanning = false;
                
                if (this.scanInterval) {
                    clearInterval(this.scanInterval);
                    this.scanInterval = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.video.srcObject = null;
                this.video.style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                
                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                document.getElementById('scanStatus').textContent = 'Clique em "Iniciar C√¢mera" para come√ßar';
                document.getElementById('scanStatus').className = 'text-lg';
                
                this.log('C√¢mera parada', 'info');
            }

            switchCamera(deviceId) {
                if (this.isScanning) {
                    this.stopCamera();
                    setTimeout(() => this.startCamera(), 500);
                }
            }

            scanFrame() {
                if (!this.isScanning || this.video.readyState !== this.video.HAVE_ENOUGH_DATA) {
                    return;
                }
                
                const startTime = performance.now();
                
                try {
                    // Draw video frame to canvas
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // Get image data
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Scan for QR codes using jsQR
                    const code = jsQR(imageData.data, this.canvas.width, this.canvas.height);
                    
                    if (code) {
                        const endTime = performance.now();
                        const scanTime = Math.round(endTime - startTime);
                        
                        this.handleScanSuccess(code.data, scanTime);
                        this.stopCamera(); // Stop scanning after successful detection
                    }
                } catch (error) {
                    this.log(`Erro durante escaneamento: ${error.message}`, 'error');
                }
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.log(`Processando arquivo: ${file.name}`);
                const startTime = performance.now();
                
                try {
                    const imageData = await this.fileToImageData(file);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    const endTime = performance.now();
                    const scanTime = Math.round(endTime - startTime);
                    
                    if (code) {
                        this.handleScanSuccess(code.data, scanTime);
                    } else {
                        this.handleScanError('Nenhum QR Code encontrado na imagem', scanTime);
                    }
                } catch (error) {
                    const endTime = performance.now();
                    const scanTime = Math.round(endTime - startTime);
                    this.handleScanError(error.message, scanTime);
                }
            }

            fileToImageData(file) {
                return new Promise((resolve, reject) => {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        reject(new Error('Arquivo deve ser uma imagem v√°lida'));
                        return;
                    }
                    
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        reject(new Error('Arquivo muito grande (m√°ximo 10MB)'));
                        return;
                    }
                    
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    // Set timeout for image loading
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout ao carregar imagem'));
                    }, 10000);
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        
                        try {
                            // Validate image dimensions
                            if (img.width === 0 || img.height === 0) {
                                reject(new Error('Imagem com dimens√µes inv√°lidas'));
                                return;
                            }
                            
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // Clean up object URL
                            URL.revokeObjectURL(img.src);
                            
                            resolve(imageData);
                        } catch (error) {
                            reject(new Error(`Erro ao processar imagem: ${error.message}`));
                        }
                    };
                    
                    img.onerror = (error) => {
                        clearTimeout(timeout);
                        URL.revokeObjectURL(img.src);
                        reject(new Error('Formato de imagem n√£o suportado ou arquivo corrompido'));
                    };
                    
                    try {
                        img.src = URL.createObjectURL(file);
                    } catch (error) {
                        reject(new Error('Erro ao criar URL da imagem'));
                    }
                });
            }

            handleScanSuccess(data, scanTime = 0) {
                this.stats.detected++;
                this.stats.success++;
                this.stats.totalTime += scanTime;
                this.stats.scanCount++;
                
                // Normalizar dados AT se necess√°rio
                const normalizationResult = this.normalizeATData(data);
                const finalData = normalizationResult.normalizedData;
                const wasNormalized = normalizationResult.wasNormalized;
                
                this.updateStatistics();
                this.showResult(finalData, true, wasNormalized);
                this.log(`QR Code decodificado com sucesso (${scanTime}ms)`, 'success');
                
                if (wasNormalized) {
                    this.log('Dados normalizados conforme padr√£o AT (chaves convertidas para mai√∫sculas)', 'warning');
                }
                
                // Check if it's an AT invoice and show processing interface
                if (this.isATInvoice(finalData)) {
                    this.showInvoiceProcessingInterface(finalData);
                }
                
                document.getElementById('lastOperation').textContent = `Sucesso - ${new Date().toLocaleTimeString()}`;
            }

            normalizeATData(data) {
                // Padr√µes AT que devem estar em mai√∫scula
                const atPatterns = [
                    { pattern: /\ba:/gi, replacement: 'A:' },
                    { pattern: /\bb:/gi, replacement: 'B:' },
                    { pattern: /\bc:/gi, replacement: 'C:' },
                    { pattern: /\bd:/gi, replacement: 'D:' },
                    { pattern: /\be:/gi, replacement: 'E:' },
                    { pattern: /\bf:/gi, replacement: 'F:' },
                    { pattern: /\bg:/gi, replacement: 'G:' },
                    { pattern: /\bh:/gi, replacement: 'H:' },
                    { pattern: /\bi:/gi, replacement: 'I:' },
                    { pattern: /\bj:/gi, replacement: 'J:' },
                    { pattern: /\bk:/gi, replacement: 'K:' },
                    { pattern: /\bl:/gi, replacement: 'L:' },
                    { pattern: /\bm:/gi, replacement: 'M:' },
                    { pattern: /\bn:/gi, replacement: 'N:' },
                    { pattern: /\bo:/gi, replacement: 'O:' },
                    { pattern: /\bp:/gi, replacement: 'P:' },
                    { pattern: /\bq:/gi, replacement: 'Q:' },
                    { pattern: /\br:/gi, replacement: 'R:' },
                    { pattern: /\bs:/gi, replacement: 'S:' },
                    { pattern: /\bt:/gi, replacement: 'T:' },
                    { pattern: /\bu:/gi, replacement: 'U:' },
                    { pattern: /\bv:/gi, replacement: 'V:' },
                    { pattern: /\bw:/gi, replacement: 'W:' },
                    { pattern: /\bx:/gi, replacement: 'X:' },
                    { pattern: /\by:/gi, replacement: 'Y:' },
                    { pattern: /\bz:/gi, replacement: 'Z:' }
                ];

                let normalizedData = data;
                let wasNormalized = false;
                
                // Aplicar normaliza√ß√µes
                atPatterns.forEach(({ pattern, replacement }) => {
                    const originalData = normalizedData;
                    normalizedData = normalizedData.replace(pattern, replacement);
                    if (originalData !== normalizedData) {
                        wasNormalized = true;
                    }
                });

                return { normalizedData, wasNormalized };
            }

            handleScanError(message, scanTime) {
                this.stats.errors++;
                this.stats.totalTime += scanTime;
                this.stats.scanCount++;
                
                this.updateStatistics();
                this.showResult(message, false);
                this.log(`Erro: ${message} (${scanTime}ms)`, 'error');
                document.getElementById('lastOperation').textContent = `Erro - ${new Date().toLocaleTimeString()}`;
            }

            updateStatistics() {
                document.getElementById('scanCount').textContent = this.stats.detected;
                document.getElementById('successCount').textContent = this.stats.success;
                document.getElementById('errorCount').textContent = this.stats.errors;
                
                const avgTime = this.stats.scanCount > 0 ? Math.round(this.stats.totalTime / this.stats.scanCount) : 0;
                document.getElementById('avgTime').textContent = `${avgTime}ms`;
            }

            showResult(content, isSuccess, wasNormalized = false) {
                const resultsDiv = document.getElementById('results');
                const successDiv = document.getElementById('successResult');
                const errorDiv = document.getElementById('errorResult');
                
                resultsDiv.style.display = 'block';
                
                if (isSuccess) {
                    document.getElementById('qrContent').textContent = content;
                    
                    // Adicionar indicador de normaliza√ß√£o se aplic√°vel
                    const qrContentDiv = document.getElementById('qrContent').parentElement;
                    let normalizationIndicator = qrContentDiv.querySelector('.normalization-indicator');
                    
                    if (wasNormalized) {
                        if (!normalizationIndicator) {
                            normalizationIndicator = document.createElement('div');
                            normalizationIndicator.className = 'normalization-indicator mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800';
                            normalizationIndicator.innerHTML = '‚ö†Ô∏è <strong>Dados normalizados:</strong> Chaves convertidas para mai√∫scula conforme padr√£o AT';
                            qrContentDiv.appendChild(normalizationIndicator);
                        }
                    } else if (normalizationIndicator) {
                        normalizationIndicator.remove();
                    }
                    
                    successDiv.classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                } else {
                    document.getElementById('errorMessage').textContent = content;
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                    this.hideInvoiceProcessingInterface();
                }
            }

            isATInvoice(content) {
                // Check if the content contains AT invoice patterns
                return content.includes('A:') || content.includes('B:') || content.includes('C:') || 
                       content.includes('D:') || content.includes('E:') || content.includes('F:') ||
                       content.includes('G:') || content.includes('H:') || content.includes('I:');
            }

            showInvoiceProcessingInterface(qrContent) {
                const invoiceInterface = document.getElementById('invoiceProcessing');
                invoiceInterface.style.display = 'block';
                
                // Auto-fill form with QR data
                this.autoFillInvoiceForm(qrContent);
                
                this.log('Interface de processamento de fatura exibida', 'info');
            }

            hideInvoiceProcessingInterface() {
                const invoiceInterface = document.getElementById('invoiceProcessing');
                invoiceInterface.style.display = 'none';
                
                // Reset form
                this.resetInvoiceForm();
            }

            autoFillInvoiceForm(qrContent) {
                try {
                    const invoiceData = this.parseATInvoiceData(qrContent);
                    
                    // Identifica√ß√£o das Partes
                    document.getElementById('nifEmitente').value = invoiceData.nifEmitente || '';
                    document.getElementById('nifAdquirente').value = invoiceData.nifAdquirente || '';
                    document.getElementById('paisEmitente').value = invoiceData.paisEmitente || '';
                    document.getElementById('paisAdquirente').value = invoiceData.paisAdquirente || '';
                    document.getElementById('tipoAdquirente').value = invoiceData.tipoAdquirente || '';
                    
                    // Dados do Documento
                    document.getElementById('dataFatura').value = invoiceData.dataFatura || '';
                    document.getElementById('tipoDocumento').value = invoiceData.tipoDocumento || '';
                    document.getElementById('numeroDocumento').value = invoiceData.numeroDocumento || '';
                    document.getElementById('codigoDocumento').value = invoiceData.codigoDocumento || '';
                    
                    // Valores e IVA
                    document.getElementById('moeda').value = invoiceData.moeda || '';
                    document.getElementById('valoresIVATaxas').value = invoiceData.valoresIVATaxas || '';
                    document.getElementById('baseTributavel').value = invoiceData.baseTributavel || '';
                    document.getElementById('iva').value = invoiceData.iva || '';
                    document.getElementById('total').value = invoiceData.total || '';
                    document.getElementById('totalIVA').value = invoiceData.totalIVA || '';
                    document.getElementById('retencao').value = invoiceData.retencao || '';
                    
                    // IVA por Taxa
                    document.getElementById('baseIva6').value = invoiceData.baseIva6 || '';
                    document.getElementById('iva6').value = invoiceData.iva6 || '';
                    document.getElementById('baseIva13').value = invoiceData.baseIva13 || '';
                    document.getElementById('iva13').value = invoiceData.iva13 || '';
                    document.getElementById('baseIva23').value = invoiceData.baseIva23 || '';
                    document.getElementById('iva23').value = invoiceData.iva23 || '';
                    
                    // C√≥digos de Isen√ß√£o e Motivos
                    document.getElementById('ivaIsento').value = invoiceData.ivaIsento || '';
                    document.getElementById('ivaRegimeEspecial').value = invoiceData.ivaRegimeEspecial || '';
                    document.getElementById('codigoIsencao').value = invoiceData.codigoIsencao || '';
                    document.getElementById('motivoIsencao').value = invoiceData.motivoIsencao || '';
                    
                    // Campos Adicionais
                    document.getElementById('nomeEmitente').value = invoiceData.nomeEmitente || '';
                    document.getElementById('moradaEmitente').value = invoiceData.moradaEmitente || '';
                    document.getElementById('iban').value = invoiceData.iban || '';
                    
                    // Set default values for additional fields
                    document.getElementById('descricao').value = invoiceData.descricao || `Fatura ${invoiceData.tipoDocumento || 'AT'} - ${invoiceData.dataFatura || new Date().toLocaleDateString()}`;
                    document.getElementById('referenciaInterna').value = `REF-${Date.now()}`;
                    
                    // Auto-set due date (30 days from invoice date)
                    if (invoiceData.dataFatura) {
                        const invoiceDate = new Date(invoiceData.dataFatura);
                        const dueDate = new Date(invoiceDate);
                        dueDate.setDate(dueDate.getDate() + 30);
                        document.getElementById('dataVencimento').value = dueDate.toISOString().split('T')[0];
                    }
                    
                    // Pre-fill banking details if available in QR data
                    this.preFillBankingDetails(invoiceData);
                    
                    // Auto-suggest accounting category based on NIF and amount
                    this.suggestAccountingCategory(invoiceData);
                    
                    // Auto-enable relevant options based on invoice data
                    this.autoEnableRelevantOptions(invoiceData);
                    
                    this.log('Formul√°rio preenchido automaticamente com dados do QR', 'success');
                } catch (error) {
                    this.log(`Erro ao preencher formul√°rio: ${error.message}`, 'error');
                }
            }

            parseATInvoiceData(qrContent) {
                const data = {};
                const lines = qrContent.split('*');
                
                // Store raw content for additional processing
                data.rawContent = qrContent;
                
                lines.forEach(line => {
                    // Convert to uppercase for consistent processing
                    const upperLine = line.toUpperCase();
                    
                    // A-E: Identification fields
                    if (upperLine.includes('A:')) data.nifEmitente = upperLine.replace('A:', '').trim();
                    if (upperLine.includes('B:')) data.nifAdquirente = upperLine.replace('B:', '').trim();
                    if (upperLine.includes('C:')) data.paisEmitente = upperLine.replace('C:', '').trim();
                    if (upperLine.includes('D:')) data.paisAdquirente = upperLine.replace('D:', '').trim();
                    if (upperLine.includes('E:')) data.tipoAdquirente = upperLine.replace('E:', '').trim();
                    
                    // F-H: Document fields
                    if (upperLine.includes('F:')) {
                        const rawDate = upperLine.replace('F:', '').trim();
                        // Format date from YYYYMMDD to YYYY-MM-DD
                        if (/^\d{8}$/.test(rawDate)) {
                            const year = rawDate.substring(0, 4);
                            const month = rawDate.substring(4, 6);
                            const day = rawDate.substring(6, 8);
                            data.dataFatura = `${year}-${month}-${day}`;
                        } else {
                            data.dataFatura = rawDate;
                        }
                    }
                    if (upperLine.includes('G:')) data.numeroDocumento = upperLine.replace('G:', '').trim();
                    if (upperLine.includes('H:')) data.codigoDocumento = upperLine.replace('H:', '').trim();
                    
                    // Document type mapping (from D field)
                    if (upperLine.includes('D:')) {
                        const docType = upperLine.replace('D:', '').trim();
                        const documentTypes = {
                            'FR': 'Fatura-Recibo',
                            'FT': 'Fatura',
                            'NC': 'Nota de Cr√©dito',
                            'ND': 'Nota de D√©bito',
                            'VD': 'Venda a Dinheiro',
                            'TV': 'Tal√£o de Venda',
                            'TD': 'Tal√£o de Devolu√ß√£o',
                            'AA': 'Aliena√ß√£o de Ativos',
                            'DA': 'Devolu√ß√£o de Ativos'
                        };
                        data.tipoDocumento = documentTypes[docType] || docType;
                    }
                    
                    // I1-I8: Tax and value fields
                    if (upperLine.includes('I1:')) data.moeda = upperLine.replace('I1:', '').trim();
                    if (upperLine.includes('I2:')) data.valoresIVATaxas = upperLine.replace('I2:', '').trim();
                    if (upperLine.includes('I3:')) data.ivaIsento = upperLine.replace('I3:', '').trim();
                    if (upperLine.includes('I4:')) data.ivaRegimeEspecial = upperLine.replace('I4:', '').trim();
                    if (upperLine.includes('I5:')) data.total = upperLine.replace('I5:', '').trim();
                    if (upperLine.includes('I6:')) data.retencao = upperLine.replace('I6:', '').trim();
                    if (upperLine.includes('I7:')) data.baseTributavel = upperLine.replace('I7:', '').trim();
                    if (upperLine.includes('I8:')) data.iva = upperLine.replace('I8:', '').trim();
                    
                    // J1-J6: Additional IVA rates
                    if (upperLine.includes('J1:')) data.baseIva6 = upperLine.replace('J1:', '').trim();
                    if (upperLine.includes('J2:')) data.iva6 = upperLine.replace('J2:', '').trim();
                    if (upperLine.includes('J3:')) data.baseIva13 = upperLine.replace('J3:', '').trim();
                    if (upperLine.includes('J4:')) data.iva13 = upperLine.replace('J4:', '').trim();
                    if (upperLine.includes('J5:')) data.baseIva23 = upperLine.replace('J5:', '').trim();
                    if (upperLine.includes('J6:')) data.iva23 = upperLine.replace('J6:', '').trim();
                    
                    // N-O: Total fields
                    if (upperLine.includes('N:')) data.totalIVA = upperLine.replace('N:', '').trim();
                    if (upperLine.includes('O:')) data.total = upperLine.replace('O:', '').trim();
                    
                    // Q-R: Exemption codes
                    if (upperLine.includes('Q:')) data.codigoIsencao = upperLine.replace('Q:', '').trim();
                    if (upperLine.includes('R:')) data.motivoIsencao = upperLine.replace('R:', '').trim();
                    
                    // Additional fields that might be present
                    if (line.includes('K:')) data.nomeEmitente = line.replace('K:', '').trim();
                    if (line.includes('L:')) data.moradaEmitente = line.replace('L:', '').trim();
                    if (line.includes('M:')) data.iban = line.replace('M:', '').trim();
                    if (line.includes('N:')) data.descricao = line.replace('N:', '').trim();
                });
                
                // Try to extract company name from NIF if not directly available
                if (!data.nomeEmitente && data.nifEmitente) {
                    data.nomeEmitente = this.lookupCompanyByNIF(data.nifEmitente);
                }
                
                return data;
            }

            // Lookup company name by NIF (simplified version)
            lookupCompanyByNIF(nif) {
                // In a real implementation, this would query a database or API
                // For now, return a placeholder based on NIF patterns
                const commonCompanies = {
                    '500000000': 'EDP - Energias de Portugal',
                    '501442600': 'Vodafone Portugal',
                    '502011475': 'NOS Comunica√ß√µes',
                    '503504564': 'MEO - Servi√ßos de Comunica√ß√µes',
                    '500769405': 'Galp Energia'
                };
                
                return commonCompanies[nif] || null;
            }

            resetInvoiceForm() {
                // Reset all form fields
                const inputs = document.querySelectorAll('#invoiceProcessing input, #invoiceProcessing select, #invoiceProcessing textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                // Hide all option sections
                document.getElementById('bankingOptions').style.display = 'none';
                document.getElementById('ivaOptions').style.display = 'none';
                document.getElementById('categoryOptions').style.display = 'none';
                document.getElementById('payableOptions').style.display = 'none';
                document.getElementById('alertOptions').style.display = 'none';
            }

            cancelInvoiceProcessing() {
                this.hideInvoiceProcessingInterface();
                this.log('Processamento de fatura cancelado', 'info');
            }

            saveInvoiceAsDraft() {
                const invoiceData = this.collectInvoiceData();
                
                // Save to localStorage as draft
                const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '[]');
                drafts.push({
                    ...invoiceData,
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    status: 'draft'
                });
                localStorage.setItem('invoiceDrafts', JSON.stringify(drafts));
                
                this.log('Fatura salva como rascunho', 'success');
                this.hideInvoiceProcessingInterface();
            }

            async processInvoiceData() {
                try {
                    const invoiceData = this.collectInvoiceData();
                    const enabledIntegrations = this.getEnabledIntegrations();

                    this.log('Iniciando processamento da fatura...', 'info');

                    // Validate required fields
                    if (!this.validateInvoiceData(invoiceData)) {
                        this.log('Dados da fatura incompletos', 'error');
                        return;
                    }

                    // Process each enabled integration
                    const results = {
                        invoice: invoiceData,
                        integrations: {},
                        timestamp: new Date().toISOString()
                    };

                    if (enabledIntegrations.banking) {
                        results.integrations.banking = await this.processBankingIntegration(invoiceData);
                    }

                    if (enabledIntegrations.iva) {
                        results.integrations.iva = this.processIVAControl(invoiceData);
                    }

                    if (enabledIntegrations.accounting) {
                        results.integrations.accounting = this.processAccountingCategory(invoiceData);
                    }

                    if (enabledIntegrations.payable) {
                        results.integrations.payable = this.processAccountsPayable(invoiceData);
                    }

                    if (enabledIntegrations.alerts) {
                        results.integrations.alerts = this.processAlerts(invoiceData);
                    }

                    // Save processed invoice
                    this.saveProcessedInvoice(results);

                    // Show success message with integration results
                    this.showProcessingResults(results);

                    // Hide processing interface
                    this.hideInvoiceProcessingInterface();

                    this.log('Fatura processada com sucesso!', 'success');

                } catch (error) {
                    this.log(`Erro no processamento: ${error.message}`, 'error');
                }
            }

            collectInvoiceData() {
                return {
                    // Basic invoice data
                    nifEmitente: document.getElementById('nifEmitente').value,
                    nifAdquirente: document.getElementById('nifAdquirente').value,
                    dataFatura: document.getElementById('dataFatura').value,
                    tipoDocumento: document.getElementById('tipoDocumento').value,
                    baseTributavel: document.getElementById('baseTributavel').value,
                    iva: document.getElementById('iva').value,
                    total: document.getElementById('total').value,
                    
                    // Additional fields
                    descricao: document.getElementById('descricao').value,
                    referenciaInterna: document.getElementById('referenciaInterna').value,
                    centroCusto: document.getElementById('centroCusto').value,
                    
                    // Actions
                    actions: {
                        efetuarPagamento: document.getElementById('efetuarPagamento').checked,
                        registrarIVA: document.getElementById('registrarIVA').checked,
                        categorizarFatura: document.getElementById('categorizarFatura').checked,
                        contasPagar: document.getElementById('contasPagar').checked,
                        anexarComprovativo: document.getElementById('anexarComprovativo').checked,
                        criarAlerta: document.getElementById('criarAlerta').checked
                    },
                    
                    // Options data
                    banking: {
                        banco: document.getElementById('bancoSelect').value,
                        conta: document.getElementById('contaBancaria').value
                    },
                    
                    iva: {
                        regime: document.getElementById('regimeIVA').value
                    },
                    
                    category: {
                        categoria: document.getElementById('categoriaContabil').value,
                        tags: document.getElementById('tagsPersonalizadas').value
                    },
                    
                    payable: {
                        dataVencimento: document.getElementById('dataVencimento').value
                    },
                    
                    alert: {
                        tipo: document.getElementById('tipoAlerta').value,
                        antecedencia: document.getElementById('antecedenciaAlerta').value
                    }
                };
            }

            copyToClipboard() {
                const content = document.getElementById('qrContent').textContent;
                navigator.clipboard.writeText(content).then(() => {
                    this.log('Conte√∫do copiado para a √°rea de transfer√™ncia', 'success');
                });
            }

            downloadResult() {
                const content = document.getElementById('qrContent').textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'qr-code-content.txt';
                a.click();
                URL.revokeObjectURL(url);
                this.log('Resultado baixado como arquivo', 'success');
            }

            clearLog() {
                const debugLog = document.getElementById('debugLog');
                debugLog.innerHTML = '<div class="text-gray-600">[INFO] Log limpo</div>';
            }

            exportLog() {
                const debugLog = document.getElementById('debugLog');
                const content = debugLog.textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'debug-log.txt';
                a.click();
                URL.revokeObjectURL(url);
                this.log('Log exportado como arquivo', 'success');
            }

            // Pre-fill banking details from QR data
            preFillBankingDetails(invoiceData) {
                try {
                    // Extract banking information from QR data if available
                    const beneficiario = this.extractBeneficiario(invoiceData);
                    const iban = this.extractIBAN(invoiceData);
                    const valor = invoiceData.total || '';
                    const referencia = this.generatePaymentReference(invoiceData);

                    // Update pre-filled banking details display
                    const beneficiarioEl = document.getElementById('beneficiarioPreenchido');
                    const ibanEl = document.getElementById('ibanPreenchido');
                    const valorEl = document.getElementById('valorPreenchido');
                    const referenciaEl = document.getElementById('referenciaPreenchida');

                    if (beneficiarioEl) beneficiarioEl.textContent = beneficiario || 'N√£o dispon√≠vel';
                    if (ibanEl) ibanEl.textContent = iban || 'N√£o dispon√≠vel';
                    if (valorEl) valorEl.textContent = valor ? `‚Ç¨${valor}` : 'N√£o dispon√≠vel';
                    if (referenciaEl) referenciaEl.textContent = referencia || 'Ser√° gerada automaticamente';

                    // Show/hide banking details section based on available data
                    const bankingDetailsDiv = document.getElementById('bankingDetails');
                    if (bankingDetailsDiv) {
                        if (beneficiario || iban) {
                            bankingDetailsDiv.style.display = 'block';
                        } else {
                            bankingDetailsDiv.style.display = 'none';
                        }
                    }

                    this.log('Detalhes banc√°rios pr√©-preenchidos', 'info');
                } catch (error) {
                    this.log(`Erro ao pr√©-preencher detalhes banc√°rios: ${error.message}`, 'warning');
                }
            }

            // Extract beneficiary name from invoice data
            extractBeneficiario(invoiceData) {
                // Try to extract company name from QR data or use NIF lookup
                if (invoiceData.nomeEmitente) {
                    return invoiceData.nomeEmitente;
                }
                if (invoiceData.nifEmitente) {
                    const companyName = this.lookupCompanyByNIF(invoiceData.nifEmitente);
                    return companyName || `Empresa NIF: ${invoiceData.nifEmitente}`;
                }
                return null;
            }

            // Extract IBAN from QR data if available
            extractIBAN(invoiceData) {
                // Check if IBAN is directly available in parsed data
                if (invoiceData.iban) {
                    return invoiceData.iban;
                }
                
                // Look for IBAN pattern in raw QR content (Portuguese format)
                if (invoiceData.rawContent) {
                    const ibanPattern = /PT50\d{21}|PT\d{23}/g;
                    const match = invoiceData.rawContent.match(ibanPattern);
                    if (match) return match[0];
                }
                
                // Try to extract from other common patterns
                const commonIbanPatterns = [
                    /IBAN[:\s]*([A-Z]{2}\d{2}[A-Z0-9]{4}\d{7}[A-Z0-9]{1,16})/i,
                    /PT[0-9]{21}/g
                ];
                
                for (const pattern of commonIbanPatterns) {
                    const match = invoiceData.rawContent?.match(pattern);
                    if (match) return match[1] || match[0];
                }
                
                return null;
            }

            // Generate payment reference based on invoice data
            generatePaymentReference(invoiceData) {
                const nif = invoiceData.nifEmitente?.slice(-4) || '0000';
                const docNumber = invoiceData.numeroDocumento?.slice(-3) || '000';
                const date = invoiceData.dataFatura?.replace(/-/g, '').slice(-6) || new Date().toISOString().slice(0, 10).replace(/-/g, '').slice(-6);
                return `${nif}${docNumber}${date}`;
            }

            // Update alert preview based on current settings
            updateAlertPreview() {
                try {
                    const tipoAlerta = document.getElementById('tipoAlerta')?.value || 'vencimento';
                    const antecedencia = document.getElementById('antecedenciaAlerta')?.value || '3';
                    const email = document.getElementById('alertEmail')?.checked;
                    const sms = document.getElementById('alertSMS')?.checked;
                    const push = document.getElementById('alertPush')?.checked;

                    const methods = [];
                    if (email) methods.push('Email');
                    if (sms) methods.push('SMS');
                    if (push) methods.push('Push');

                    const methodsText = methods.length > 0 ? methods.join(', ') : 'Nenhum m√©todo selecionado';
                    
                    let previewText = '';
                    switch (tipoAlerta) {
                        case 'vencimento':
                            previewText = `Alerta de vencimento ser√° enviado ${antecedencia} dias antes via ${methodsText}`;
                            break;
                        case 'reconciliacao':
                            previewText = `Alerta de reconcilia√ß√£o ser√° enviado ${antecedencia} dias antes via ${methodsText}`;
                            break;
                        case 'pagamento':
                            previewText = `Alerta de pagamento ser√° enviado ${antecedencia} dias antes via ${methodsText}`;
                            break;
                        case 'ambos':
                            previewText = `Todos os alertas ser√£o enviados ${antecedencia} dias antes via ${methodsText}`;
                            break;
                    }

                    const previewElement = document.getElementById('alertPreviewText');
                    if (previewElement) {
                        previewElement.textContent = previewText;
                    }
                } catch (error) {
                    this.log(`Erro ao atualizar preview do alerta: ${error.message}`, 'warning');
                }
            }

            // Enhanced logging with structured data
            log(message, type = 'info', context = {}) {
                const timestamp = new Date().toISOString();
                const timeString = new Date().toLocaleTimeString('pt-PT', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });
                
                const logContainer = document.getElementById('debugLog');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry text-gray-600`;
                logEntry.dataset.level = type;
                logEntry.dataset.timestamp = timestamp;
                
                let icon = '';
                let colorClass = '';
                
                switch (type) {
                    case 'success':
                        icon = '‚úÖ';
                        colorClass = 'text-green-600';
                        break;
                    case 'error':
                        icon = '‚ùå';
                        colorClass = 'text-red-600';
                        break;
                    case 'warning':
                        icon = '‚ö†Ô∏è';
                        colorClass = 'text-yellow-600';
                        break;
                    case 'debug':
                        icon = 'üîß';
                        colorClass = 'text-purple-600';
                        break;
                    default:
                        icon = '‚ÑπÔ∏è';
                        colorClass = 'text-blue-600';
                }
                
                logEntry.className += ` ${colorClass}`;
                
                logEntry.innerHTML = `
                    <span class="timestamp">[${timeString}]</span> 
                    <span class="level">[${type.toUpperCase()}]</span> 
                    <span class="message">${message}</span>
                    <span class="context" data-context='${JSON.stringify(context)}' style="display:none;"></span>
                `;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Update statistics
                this.updateSessionStats(type);
                
                // Update last operation
                document.getElementById('lastOperation').textContent = message;
                document.getElementById('lastOperationTime').textContent = timeString;
                
                // Store in session for analysis
                if (!window.debugSession) {
                    window.debugSession = {
                        logs: [],
                        stats: { info: 0, success: 0, warning: 0, error: 0, debug: 0 },
                        startTime: Date.now()
                    };
                }
                
                window.debugSession.logs.push({
                    timestamp,
                    level: type,
                    message,
                    context
                });
                
                // Manter apenas os √∫ltimos 200 logs
                while (logContainer.children.length > 200) {
                    logContainer.removeChild(logContainer.firstChild);
                }
                
                // Update technical details
                this.updateTechnicalDetails();
            }

            // Enhanced debug functionality methods
            clearLog() {
                const debugLog = document.getElementById('debugLog');
                debugLog.innerHTML = `
                    <div class="text-gray-600 log-entry" data-level="info" data-timestamp="${new Date().toISOString()}">
                        <span class="timestamp">[${new Date().toLocaleTimeString('pt-PT', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 })}]</span> 
                        <span class="level">[INFO]</span> 
                        <span class="message">Log limpo - Sistema reiniciado</span>
                        <span class="context" data-context='{"action":"clear","user":"manual"}' style="display:none;"></span>
                    </div>
                `;
                
                // Reset session stats
                if (window.debugSession) {
                    window.debugSession.logs = [];
                    window.debugSession.stats = { info: 0, success: 0, warning: 0, error: 0, debug: 0 };
                }
                
                this.updateSessionStats('info');
            }

            exportLog() {
                const debugLog = document.getElementById('debugLog');
                const logEntries = debugLog.querySelectorAll('.log-entry');
                
                let content = '=== QR CODE READER - DEBUG LOG EXPORT ===\n';
                content += `Export Date: ${new Date().toISOString()}\n`;
                content += `Session Duration: ${this.getSessionDuration()}\n`;
                content += `Total Entries: ${logEntries.length}\n\n`;
                
                // Add environment info
                content += '=== ENVIRONMENT INFO ===\n';
                content += `User Agent: ${navigator.userAgent}\n`;
                content += `Platform: ${navigator.platform}\n`;
                content += `Language: ${navigator.language}\n`;
                content += `Online: ${navigator.onLine}\n\n`;
                
                // Add log entries
                content += '=== LOG ENTRIES ===\n';
                logEntries.forEach(entry => {
                    const timestamp = entry.dataset.timestamp;
                    const level = entry.dataset.level;
                    const message = entry.querySelector('.message').textContent;
                    const contextEl = entry.querySelector('.context');
                    const context = contextEl ? contextEl.dataset.context : '{}';
                    
                    content += `[${timestamp}] [${level.toUpperCase()}] ${message}\n`;
                    if (context && context !== '{}') {
                        content += `  Context: ${context}\n`;
                    }
                });
                
                // Add session statistics
                if (window.debugSession) {
                    content += '\n=== SESSION STATISTICS ===\n';
                    content += JSON.stringify(window.debugSession.stats, null, 2);
                }
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qr-debug-log-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.log('Log exportado com dados estruturados', 'success', { 
                    entries: logEntries.length,
                    format: 'structured'
                });
            }

            generateDebugReport() {
                const report = {
                    timestamp: new Date().toISOString(),
                    session: window.debugSession || {},
                    environment: this.getEnvironmentInfo(),
                    camera: this.getCameraInfo(),
                    qrStats: this.getQRStats(),
                    errorAnalysis: this.getErrorAnalysis(),
                    performance: this.getPerformanceMetrics()
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qr-system-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.log('Relat√≥rio completo do sistema gerado', 'success', { 
                    reportSize: JSON.stringify(report).length,
                    sections: Object.keys(report).length
                });
            }

            filterLogs(level) {
                const logEntries = document.querySelectorAll('.log-entry');
                const filterButtons = document.querySelectorAll('.log-filter');
                
                // Update button states
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-gray-800', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                
                const activeButton = document.querySelector(`[data-level="${level}"]`);
                if (activeButton) {
                    activeButton.classList.remove('bg-gray-200', 'text-gray-700');
                    activeButton.classList.add('active', 'bg-gray-800', 'text-white');
                }
                
                // Filter entries
                logEntries.forEach(entry => {
                    if (level === 'all' || entry.dataset.level === level) {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                });
                
                this.log(`Filtro aplicado: ${level}`, 'debug', { filter: level });
            }

            updateSessionStats(level) {
                if (!window.debugSession) return;
                
                window.debugSession.stats[level] = (window.debugSession.stats[level] || 0) + 1;
                
                const total = Object.values(window.debugSession.stats).reduce((a, b) => a + b, 0);
                const errors = window.debugSession.stats.error || 0;
                const successRate = total > 0 ? Math.round(((total - errors) / total) * 100) : 100;
                
                document.getElementById('sessionStats').textContent = 
                    `QRs: ${window.debugSession.stats.success || 0} | Erros: ${errors}`;
                document.getElementById('successRate').textContent = 
                    `Taxa sucesso: ${successRate}%`;
                
                // Update uptime
                document.getElementById('uptime').textContent = 
                    `Uptime: ${this.getSessionDuration()}`;
            }

            getSessionDuration() {
                if (!window.debugSession) return '00:00:00';
                
                const duration = Date.now() - window.debugSession.startTime;
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            getEnvironmentInfo() {
                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    hardwareConcurrency: navigator.hardwareConcurrency || 0,
                    deviceMemory: navigator.deviceMemory || 0,
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt
                    } : null
                };
            }

            getCameraInfo() {
                return {
                    available: !!navigator.mediaDevices,
                    permissions: 'unknown',
                    constraints: this.currentConstraints || {},
                    activeStream: !!this.stream,
                    supportedFormats: ['video/mp4', 'image/jpeg', 'image/png']
                };
            }

            getQRStats() {
                const session = window.debugSession || {};
                const logs = session.logs || [];
                
                const qrLogs = logs.filter(log => 
                    log.message.includes('QR') || 
                    log.message.includes('processamento') ||
                    log.message.includes('leitura')
                );
                
                return {
                    totalScanned: qrLogs.filter(log => log.level === 'success').length,
                    successfulReads: qrLogs.filter(log => log.message.includes('sucesso')).length,
                    failedReads: qrLogs.filter(log => log.level === 'error').length,
                    averageProcessingTime: 0,
                    lastQRData: logs.find(log => log.context && log.context.qrData)?.context.qrData || null,
                    errorPatterns: this.analyzeErrorPatterns(logs)
                };
            }

            analyzeErrorPatterns(logs) {
                const errors = logs.filter(log => log.level === 'error');
                const patterns = {};
                
                errors.forEach(error => {
                    const key = error.message.split(':')[0];
                    patterns[key] = (patterns[key] || 0) + 1;
                });
                
                return Object.entries(patterns)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
            }

            getErrorAnalysis() {
                const session = window.debugSession || {};
                const logs = session.logs || [];
                const errors = logs.filter(log => log.level === 'error');
                
                return {
                    recentErrors: errors.slice(-10).map(e => ({
                        timestamp: e.timestamp,
                        message: e.message,
                        context: e.context
                    })),
                    errorFrequency: this.analyzeErrorPatterns(logs).reduce((acc, [pattern, count]) => {
                        acc[pattern] = count;
                        return acc;
                    }, {}),
                    criticalIssues: errors.filter(e => 
                        e.message.includes('cr√≠tico') || 
                        e.message.includes('fatal') ||
                        e.message.includes('crash')
                    ),
                    suggestedFixes: this.generateSuggestedFixes(errors)
                };
            }

            generateSuggestedFixes(errors) {
                const fixes = [];
                const errorMessages = errors.map(e => e.message.toLowerCase());
                
                if (errorMessages.some(msg => msg.includes('camera'))) {
                    fixes.push('Verificar permiss√µes da c√¢mera no navegador');
                }
                
                if (errorMessages.some(msg => msg.includes('qr'))) {
                    fixes.push('Melhorar qualidade da imagem ou ilumina√ß√£o');
                }
                
                if (errorMessages.some(msg => msg.includes('network') || msg.includes('fetch'))) {
                    fixes.push('Verificar conex√£o de internet');
                }
                
                return fixes;
            }

            getPerformanceMetrics() {
                const memory = performance.memory || {};
                
                return {
                    memory: {
                        used: Math.round((memory.usedJSHeapSize || 0) / 1024 / 1024),
                        total: Math.round((memory.totalJSHeapSize || 0) / 1024 / 1024),
                        limit: Math.round((memory.jsHeapSizeLimit || 0) / 1024 / 1024)
                    },
                    timing: performance.timing ? {
                        loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
                        domReady: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart
                    } : null,
                    navigation: performance.navigation ? {
                        type: performance.navigation.type,
                        redirectCount: performance.navigation.redirectCount
                    } : null
                };
            }

            updateTechnicalDetails() {
                // Update environment info
                const envInfo = document.getElementById('envInfo');
                if (envInfo) {
                    envInfo.textContent = JSON.stringify(this.getEnvironmentInfo(), null, 2);
                }
                
                // Update camera info
                const cameraInfo = document.getElementById('cameraInfo');
                if (cameraInfo) {
                    cameraInfo.textContent = JSON.stringify(this.getCameraInfo(), null, 2);
                }
                
                // Update QR stats
                const qrStats = document.getElementById('qrStats');
                if (qrStats) {
                    qrStats.textContent = JSON.stringify(this.getQRStats(), null, 2);
                }
                
                // Update error analysis
                const errorAnalysis = document.getElementById('errorAnalysis');
                if (errorAnalysis) {
                    errorAnalysis.textContent = JSON.stringify(this.getErrorAnalysis(), null, 2);
                }
                
                // Update performance metrics
                const performanceEl = document.getElementById('performanceMetrics');
                if (performanceEl) {
                    const metrics = this.getPerformanceMetrics();
                    performanceEl.textContent = `CPU: N/A | RAM: ${metrics.memory.used}MB`;
                }
                
                const processingTimeEl = document.getElementById('processingTime');
                if (processingTimeEl) {
                    const avgTime = window.debugSession?.averageProcessingTime || 0;
                    processingTimeEl.textContent = `Tempo m√©dio: ${avgTime}ms`;
                }
            }

            // Suggest accounting category based on invoice data
            suggestAccountingCategory(invoiceData) {
                const categorySelect = document.getElementById('categoriaContabil');
                const suggestionElement = document.getElementById('sugestaoCategoria');
                if (!categorySelect) return;

                const amount = parseFloat(invoiceData.total) || 0;
                const nifEmitente = invoiceData.nifEmitente || '';
                const description = invoiceData.descricao || '';

                // Enhanced category suggestions based on multiple factors
                let suggestedCategory = 'outros';
                let reasoning = '';

                // Amount-based suggestions
                if (amount > 10000) {
                    suggestedCategory = 'equipamentos';
                    reasoning = 'Valor elevado - poss√≠vel aquisi√ß√£o de equipamento';
                } else if (amount > 5000) {
                    suggestedCategory = 'fornecimentos-servicos-externos';
                    reasoning = 'Valor m√©dio-alto - servi√ßos ou fornecimentos';
                } else if (amount > 1000) {
                    suggestedCategory = 'servicos-profissionais';
                    reasoning = 'Valor m√©dio - servi√ßos profissionais';
                } else if (amount < 100) {
                    suggestedCategory = 'comunicacoes';
                    reasoning = 'Valor baixo - comunica√ß√µes ou despesas menores';
                }

                // NIF pattern analysis (Portuguese business patterns)
                if (nifEmitente.startsWith('5')) {
                    suggestedCategory = 'servicos-profissionais';
                    reasoning = 'NIF de pessoa coletiva - servi√ßos profissionais';
                } else if (nifEmitente.startsWith('2')) {
                    suggestedCategory = 'fornecimentos-servicos-externos';
                    reasoning = 'NIF empresarial - fornecimentos e servi√ßos';
                }

                // Description-based suggestions
                const descLower = description.toLowerCase();
                if (descLower.includes('combustivel') || descLower.includes('gasolina')) {
                    suggestedCategory = 'viagens-deslocacoes';
                    reasoning = 'Combust√≠vel identificado - viagens e desloca√ß√µes';
                } else if (descLower.includes('telefone') || descLower.includes('internet')) {
                    suggestedCategory = 'comunicacoes';
                    reasoning = 'Comunica√ß√µes identificadas';
                } else if (descLower.includes('seguro')) {
                    suggestedCategory = 'seguros';
                    reasoning = 'Seguro identificado';
                } else if (descLower.includes('marketing') || descLower.includes('publicidade')) {
                    suggestedCategory = 'marketing-publicidade';
                    reasoning = 'Marketing/Publicidade identificado';
                }

                // Set the suggested category
                categorySelect.value = suggestedCategory;
                
                // Update suggestion display
                if (suggestionElement) {
                    suggestionElement.textContent = `${this.getCategoryDisplayName(suggestedCategory)} - ${reasoning}`;
                }

                this.log(`Categoria cont√°bil sugerida: ${suggestedCategory} (${reasoning})`, 'info');
            }

            // Get display name for category
            getCategoryDisplayName(categoryValue) {
                const categoryNames = {
                    'fornecimentos-servicos-externos': 'Fornecimentos e Servi√ßos Externos',
                    'mercadorias': 'Mercadorias',
                    'materias-primas': 'Mat√©rias-primas',
                    'equipamentos': 'Equipamentos',
                    'servicos-profissionais': 'Servi√ßos Profissionais',
                    'marketing-publicidade': 'Marketing e Publicidade',
                    'viagens-deslocacoes': 'Viagens e Desloca√ß√µes',
                    'comunicacoes': 'Comunica√ß√µes',
                    'seguros': 'Seguros',
                    'outros': 'Outros'
                };
                return categoryNames[categoryValue] || categoryValue;
            }

            // Auto-enable relevant options based on invoice data
            autoEnableRelevantOptions(invoiceData) {
                const amount = parseFloat(invoiceData.total) || 0;
                const hasIVA = parseFloat(invoiceData.iva) > 0;

                // Auto-enable IVA control if invoice has IVA
                if (hasIVA) {
                    document.getElementById('controleIVA').checked = true;
                    document.getElementById('ivaOptions').style.display = 'block';
                    this.log('Controle de IVA ativado automaticamente', 'info');
                }

                // Auto-enable accounts payable for amounts > 500‚Ç¨
                if (amount > 500) {
                    document.getElementById('contasPagar').checked = true;
                    document.getElementById('payableOptions').style.display = 'block';
                    this.log('Contas a pagar ativado automaticamente', 'info');
                }

                // Auto-enable banking integration for amounts > 100‚Ç¨
                if (amount > 100) {
                    document.getElementById('integracaoBancaria').checked = true;
                    document.getElementById('bankingOptions').style.display = 'block';
                    this.log('Integra√ß√£o banc√°ria ativada automaticamente', 'info');
                }

                // Auto-enable alerts for amounts > 1000‚Ç¨
                if (amount > 1000) {
                    document.getElementById('criarAlerta').checked = true;
                    document.getElementById('alertOptions').style.display = 'block';
                    this.log('Alertas ativados automaticamente', 'info');
                }
            }

            // Enhanced invoice processing with integrations
            async processInvoiceData() {
                try {
                    const invoiceData = this.collectInvoiceData();
                    const enabledIntegrations = this.getEnabledIntegrations();

                    this.log('Iniciando processamento da fatura...', 'info');

                    // Validate required fields
                    if (!this.validateInvoiceData(invoiceData)) {
                        this.log('Dados da fatura incompletos', 'error');
                        return;
                    }

                    // Process each enabled integration
                    const results = {
                        invoice: invoiceData,
                        integrations: {},
                        timestamp: new Date().toISOString()
                    };

                    if (enabledIntegrations.banking) {
                        results.integrations.banking = await this.processBankingIntegration(invoiceData);
                    }

                    if (enabledIntegrations.iva) {
                        results.integrations.iva = this.processIVAControl(invoiceData);
                    }

                    if (enabledIntegrations.accounting) {
                        results.integrations.accounting = this.processAccountingCategory(invoiceData);
                    }

                    if (enabledIntegrations.payable) {
                        results.integrations.payable = this.processAccountsPayable(invoiceData);
                    }

                    if (enabledIntegrations.alerts) {
                        results.integrations.alerts = this.processAlerts(invoiceData);
                    }

                    // Save processed invoice
                    this.saveProcessedInvoice(results);

                    // Show success message with integration results
                    this.showProcessingResults(results);

                    // Hide processing interface
                    this.hideInvoiceProcessingInterface();

                    this.log('Fatura processada com sucesso!', 'success');

                } catch (error) {
                    this.log(`Erro no processamento: ${error.message}`, 'error');
                }
            }

            // Validate invoice data
            validateInvoiceData(data) {
                const required = ['nifEmitente', 'total', 'dataFatura'];
                return required.every(field => data[field] && data[field].trim() !== '');
            }

            // Get enabled integrations
            getEnabledIntegrations() {
                return {
                    banking: document.getElementById('integracaoBancaria').checked,
                    iva: document.getElementById('controleIVA').checked,
                    accounting: document.getElementById('categorizacao').checked,
                    payable: document.getElementById('contasPagar').checked,
                    alerts: document.getElementById('criarAlerta').checked,
                    attachment: document.getElementById('anexarComprovativo').checked
                };
            }

            // Process banking integration
            async processBankingIntegration(invoiceData) {
                const selectedBank = document.getElementById('bancoSelecionado').value;
                const selectedAccount = document.getElementById('contaSelecionada').value;

                // Simulate banking API call
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            status: 'pending',
                            bank: selectedBank,
                            account: selectedAccount,
                            amount: invoiceData.total,
                            reference: `PAY-${Date.now()}`,
                            message: 'Pagamento iniciado via API banc√°ria'
                        });
                    }, 1000);
                });
            }

            // Process IVA control
            processIVAControl(invoiceData) {
                const ivaRegime = document.getElementById('regimeIVA').value;
                const ivaAmount = parseFloat(invoiceData.iva) || 0;

                return {
                    regime: ivaRegime,
                    amount: ivaAmount,
                    deductible: ivaRegime === 'pro-rata' ? ivaAmount * 0.8 : ivaAmount,
                    status: 'registered',
                    message: `IVA registrado no regime ${ivaRegime}`
                };
            }

            // Process accounting category
            processAccountingCategory(invoiceData) {
                const category = document.getElementById('categoriaContabil').value;
                const costCenter = document.getElementById('centroCusto').value;

                return {
                    category: category,
                    costCenter: costCenter,
                    amount: invoiceData.total,
                    status: 'categorized',
                    message: `Fatura categorizada como ${category}`
                };
            }

            // Process accounts payable
            processAccountsPayable(invoiceData) {
                const dueDate = document.getElementById('dataVencimento').value;

                return {
                    dueDate: dueDate,
                    amount: invoiceData.total,
                    status: 'registered',
                    payableId: `AP-${Date.now()}`,
                    message: 'Documento lan√ßado em contas a pagar'
                };
            }

            // Process alerts
            processAlerts(invoiceData) {
                const alertType = document.getElementById('tipoAlerta').value;
                const alertDays = document.getElementById('antecedenciaAlerta').value;

                return {
                    type: alertType,
                    daysAdvance: alertDays,
                    status: 'scheduled',
                    alertId: `ALERT-${Date.now()}`,
                    message: `Alerta de ${alertType} agendado para ${alertDays} dias antes`
                };
            }

            // Save processed invoice to local storage
            saveProcessedInvoice(results) {
                const processed = JSON.parse(localStorage.getItem('processedInvoices') || '[]');
                processed.push(results);
                localStorage.setItem('processedInvoices', JSON.stringify(processed));
            }

            // Show processing results
            showProcessingResults(results) {
                let message = '‚úÖ Fatura processada com sucesso!\n\n';
                
                Object.entries(results.integrations).forEach(([key, integration]) => {
                    if (integration) {
                        message += `${integration.message}\n`;
                    }
                });

                alert(message);
            }
        }

        // Initialize scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize debug session
            window.debugSession = {
                startTime: Date.now(),
                logs: [],
                stats: { info: 0, success: 0, warning: 0, error: 0, debug: 0 },
                averageProcessingTime: 0
            };
            
            // Initialize scanner
            const scanner = new JSQRScanner();
            
            // Update technical details on load
            setTimeout(() => {
                scanner.updateTechnicalDetails();
                scanner.updateSessionStats('info');
            }, 1000);
        });
    </script>
</body>
</html>