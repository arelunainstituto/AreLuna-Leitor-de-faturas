<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSQRScanner - Grupo AreLuna</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">JSQRScanner</h1>
            <p class="text-gray-600">Grupo AreLuna - Scanner de QR Codes em Tempo Real</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Camera Controls -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-center mb-4">
                    <button id="startCamera" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        Iniciar C√¢mera
                    </button>
                    <button id="stopCamera" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition-colors" disabled>
                        Parar C√¢mera
                    </button>
                    <select id="cameraSelect" class="border border-gray-300 rounded-lg px-4 py-3 bg-white">
                        <option value="">Selecionar C√¢mera</option>
                    </select>
                </div>

                <!-- Camera Feed -->
                <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 400px;">
                    <video id="video" class="w-full h-full object-cover" autoplay muted playsinline style="display: none;"></video>
                    <canvas id="canvas" class="absolute top-0 left-0 w-full h-full" style="display: none;"></canvas>
                    <div id="cameraPlaceholder" class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üì∑</div>
                            <p id="scanStatus" class="text-lg">Clique em "Iniciar C√¢mera" para come√ßar</p>
                        </div>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Imagem</label>
                    <input type="file" id="fileInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="bg-white rounded-2xl shadow-lg p-6 mb-6" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Resultado</h3>
                <div id="successResult" class="hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-green-800 font-medium mb-2">‚úÖ QR Code Decodificado</h4>
                        <div class="bg-white rounded border p-3 mb-3">
                            <code id="qrContent" class="text-sm text-gray-800 break-all"></code>
                        </div>
                        <div class="flex gap-2">
                            <button id="copyBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">Copiar</button>
                            <button id="downloadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">Download</button>
                        </div>
                    </div>
                </div>
                <div id="errorResult" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="text-red-800 font-medium mb-2">‚ùå Erro na Decodifica√ß√£o</h4>
                        <p id="errorMessage" class="text-red-700 text-sm"></p>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Estat√≠sticas do Scanner</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div id="scanCount" class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-gray-600">QR Codes Detectados</div>
                    </div>
                    <div class="text-center">
                        <div id="successCount" class="text-2xl font-bold text-green-600">0</div>
                        <div class="text-sm text-gray-600">Sucessos</div>
                    </div>
                    <div class="text-center">
                        <div id="errorCount" class="text-2xl font-bold text-red-600">0</div>
                        <div class="text-sm text-gray-600">Erros</div>
                    </div>
                    <div class="text-center">
                        <div id="avgTime" class="text-2xl font-bold text-purple-600">0ms</div>
                        <div class="text-sm text-gray-600">Tempo M√©dio</div>
                    </div>
                </div>
            </div>

            <!-- Debug Log -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Debug Log</h2>
                    <div class="flex gap-2">
                        <button id="clearLog" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">Limpar Log</button>
                        <button id="exportLog" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">Exportar Log</button>
                    </div>
                </div>
                <div id="debugLog" class="bg-gray-50 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm">
                    <div class="text-gray-600">[INFO] Debug log iniciado - QR Code Reader Service</div>
                    <div class="text-gray-600">[INFO] Sistema pronto para processar imagens</div>
                </div>
                
                <!-- System Status -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <span class="text-sm text-gray-600">Status do Sistema</span>
                        <div class="text-green-600 font-medium">‚úì Online</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">√öltima Opera√ß√£o</span>
                        <div id="lastOperation" class="text-gray-800 font-medium">Aguardando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSQRScanner JavaScript -->
    <script>
        class JSQRScanner {
            constructor() {
                this.isScanning = false;
                this.stream = null;
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.scanInterval = null;
                this.stats = {
                    detected: 0,
                    success: 0,
                    errors: 0,
                    totalTime: 0,
                    scanCount: 0
                };
                
                this.initializeElements();
                this.bindEvents();
                this.getCameraDevices();
                this.log('Sistema pronto para processar imagens');
            }

            initializeElements() {
                // Set canvas size
                this.canvas.width = 640;
                this.canvas.height = 480;
            }

            async getCameraDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.innerHTML = '<option value="">Selecionar C√¢mera</option>';
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `C√¢mera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    if (videoDevices.length > 0) {
                        this.log(`${videoDevices.length} c√¢mera(s) detectada(s)`);
                    }
                } catch (error) {
                    this.log(`Erro ao listar c√¢meras: ${error.message}`, 'error');
                }
            }

            bindEvents() {
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCamera').addEventListener('click', () => this.stopCamera());
                document.getElementById('cameraSelect').addEventListener('change', (e) => this.switchCamera(e.target.value));
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                document.getElementById('clearLog').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLog').addEventListener('click', () => this.exportLog());
                
                const copyBtn = document.getElementById('copyBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                if (copyBtn) copyBtn.addEventListener('click', () => this.copyToClipboard());
                if (downloadBtn) downloadBtn.addEventListener('click', () => this.downloadResult());
            }

            async startCamera() {
                try {
                    this.log('Iniciando c√¢mera...');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    const deviceId = cameraSelect.value;
                    
                    const constraints = {
                        video: deviceId ? { deviceId: { exact: deviceId } } : true,
                        audio: false
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    await this.video.play();
                    
                    this.isScanning = true;
                    document.getElementById('startCamera').disabled = true;
                    document.getElementById('stopCamera').disabled = false;
                    document.getElementById('scanStatus').textContent = 'Escaneando...';
                    document.getElementById('scanStatus').className = 'text-lg text-green-600 font-medium';
                    
                    // Show video, hide placeholder
                    this.video.style.display = 'block';
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    
                    this.scanInterval = setInterval(() => this.scanFrame(), 100);
                    this.log('C√¢mera iniciada com sucesso', 'success');
                } catch (error) {
                    this.log(`Erro ao iniciar c√¢mera: ${error.message}`, 'error');
                }
            }

            stopCamera() {
                this.isScanning = false;
                
                if (this.scanInterval) {
                    clearInterval(this.scanInterval);
                    this.scanInterval = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.video.srcObject = null;
                this.video.style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                
                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                document.getElementById('scanStatus').textContent = 'Clique em "Iniciar C√¢mera" para come√ßar';
                document.getElementById('scanStatus').className = 'text-lg';
                
                this.log('C√¢mera parada', 'info');
            }

            switchCamera(deviceId) {
                if (this.isScanning) {
                    this.stopCamera();
                    setTimeout(() => this.startCamera(), 500);
                }
            }

            scanFrame() {
                if (!this.isScanning || this.video.readyState !== this.video.HAVE_ENOUGH_DATA) {
                    return;
                }
                
                const startTime = performance.now();
                
                try {
                    // Draw video frame to canvas
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // Get image data
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Scan for QR codes using jsQR
                    const code = jsQR(imageData.data, this.canvas.width, this.canvas.height);
                    
                    if (code) {
                        const endTime = performance.now();
                        const scanTime = Math.round(endTime - startTime);
                        
                        this.handleScanSuccess(code.data, scanTime);
                        this.stopCamera(); // Stop scanning after successful detection
                    }
                } catch (error) {
                    this.log(`Erro durante escaneamento: ${error.message}`, 'error');
                }
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.log(`Processando arquivo: ${file.name}`);
                const startTime = performance.now();
                
                try {
                    const imageData = await this.fileToImageData(file);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    const endTime = performance.now();
                    const scanTime = Math.round(endTime - startTime);
                    
                    if (code) {
                        this.handleScanSuccess(code.data, scanTime);
                    } else {
                        this.handleScanError('Nenhum QR Code encontrado na imagem', scanTime);
                    }
                } catch (error) {
                    const endTime = performance.now();
                    const scanTime = Math.round(endTime - startTime);
                    this.handleScanError(error.message, scanTime);
                }
            }

            fileToImageData(file) {
                return new Promise((resolve, reject) => {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        reject(new Error('Arquivo deve ser uma imagem v√°lida'));
                        return;
                    }
                    
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        reject(new Error('Arquivo muito grande (m√°ximo 10MB)'));
                        return;
                    }
                    
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    // Set timeout for image loading
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout ao carregar imagem'));
                    }, 10000);
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        
                        try {
                            // Validate image dimensions
                            if (img.width === 0 || img.height === 0) {
                                reject(new Error('Imagem com dimens√µes inv√°lidas'));
                                return;
                            }
                            
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // Clean up object URL
                            URL.revokeObjectURL(img.src);
                            
                            resolve(imageData);
                        } catch (error) {
                            reject(new Error(`Erro ao processar imagem: ${error.message}`));
                        }
                    };
                    
                    img.onerror = (error) => {
                        clearTimeout(timeout);
                        URL.revokeObjectURL(img.src);
                        reject(new Error('Formato de imagem n√£o suportado ou arquivo corrompido'));
                    };
                    
                    try {
                        img.src = URL.createObjectURL(file);
                    } catch (error) {
                        reject(new Error('Erro ao criar URL da imagem'));
                    }
                });
            }

            handleScanSuccess(data, scanTime = 0) {
                this.stats.detected++;
                this.stats.success++;
                this.stats.totalTime += scanTime;
                this.stats.scanCount++;
                
                // Normalizar dados AT se necess√°rio
                const normalizationResult = this.normalizeATData(data);
                const finalData = normalizationResult.normalizedData;
                const wasNormalized = normalizationResult.wasNormalized;
                
                this.updateStatistics();
                this.showResult(finalData, true, wasNormalized);
                this.log(`QR Code decodificado com sucesso (${scanTime}ms)`, 'success');
                
                if (wasNormalized) {
                    this.log('Dados normalizados conforme padr√£o AT (chaves convertidas para mai√∫sculas)', 'warning');
                }
                
                document.getElementById('lastOperation').textContent = `Sucesso - ${new Date().toLocaleTimeString()}`;
            }

            normalizeATData(data) {
                // Padr√µes AT que devem estar em mai√∫scula
                const atPatterns = [
                    { pattern: /\ba:/gi, replacement: 'A:' },
                    { pattern: /\bb:/gi, replacement: 'B:' },
                    { pattern: /\bc:/gi, replacement: 'C:' },
                    { pattern: /\bd:/gi, replacement: 'D:' },
                    { pattern: /\be:/gi, replacement: 'E:' },
                    { pattern: /\bf:/gi, replacement: 'F:' },
                    { pattern: /\bg:/gi, replacement: 'G:' },
                    { pattern: /\bh:/gi, replacement: 'H:' },
                    { pattern: /\bi:/gi, replacement: 'I:' },
                    { pattern: /\bj:/gi, replacement: 'J:' },
                    { pattern: /\bk:/gi, replacement: 'K:' },
                    { pattern: /\bl:/gi, replacement: 'L:' },
                    { pattern: /\bm:/gi, replacement: 'M:' },
                    { pattern: /\bn:/gi, replacement: 'N:' },
                    { pattern: /\bo:/gi, replacement: 'O:' },
                    { pattern: /\bp:/gi, replacement: 'P:' },
                    { pattern: /\bq:/gi, replacement: 'Q:' },
                    { pattern: /\br:/gi, replacement: 'R:' },
                    { pattern: /\bs:/gi, replacement: 'S:' },
                    { pattern: /\bt:/gi, replacement: 'T:' },
                    { pattern: /\bu:/gi, replacement: 'U:' },
                    { pattern: /\bv:/gi, replacement: 'V:' },
                    { pattern: /\bw:/gi, replacement: 'W:' },
                    { pattern: /\bx:/gi, replacement: 'X:' },
                    { pattern: /\by:/gi, replacement: 'Y:' },
                    { pattern: /\bz:/gi, replacement: 'Z:' }
                ];

                let normalizedData = data;
                let wasNormalized = false;
                
                // Aplicar normaliza√ß√µes
                atPatterns.forEach(({ pattern, replacement }) => {
                    const originalData = normalizedData;
                    normalizedData = normalizedData.replace(pattern, replacement);
                    if (originalData !== normalizedData) {
                        wasNormalized = true;
                    }
                });

                return { normalizedData, wasNormalized };
            }

            handleScanError(message, scanTime) {
                this.stats.errors++;
                this.stats.totalTime += scanTime;
                this.stats.scanCount++;
                
                this.updateStatistics();
                this.showResult(message, false);
                this.log(`Erro: ${message} (${scanTime}ms)`, 'error');
                document.getElementById('lastOperation').textContent = `Erro - ${new Date().toLocaleTimeString()}`;
            }

            updateStatistics() {
                document.getElementById('scanCount').textContent = this.stats.detected;
                document.getElementById('successCount').textContent = this.stats.success;
                document.getElementById('errorCount').textContent = this.stats.errors;
                
                const avgTime = this.stats.scanCount > 0 ? Math.round(this.stats.totalTime / this.stats.scanCount) : 0;
                document.getElementById('avgTime').textContent = `${avgTime}ms`;
            }

            showResult(content, isSuccess, wasNormalized = false) {
                const resultsDiv = document.getElementById('results');
                const successDiv = document.getElementById('successResult');
                const errorDiv = document.getElementById('errorResult');
                
                resultsDiv.style.display = 'block';
                
                if (isSuccess) {
                    document.getElementById('qrContent').textContent = content;
                    
                    // Adicionar indicador de normaliza√ß√£o se aplic√°vel
                    const qrContentDiv = document.getElementById('qrContent').parentElement;
                    let normalizationIndicator = qrContentDiv.querySelector('.normalization-indicator');
                    
                    if (wasNormalized) {
                        if (!normalizationIndicator) {
                            normalizationIndicator = document.createElement('div');
                            normalizationIndicator.className = 'normalization-indicator mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800';
                            normalizationIndicator.innerHTML = '‚ö†Ô∏è <strong>Dados normalizados:</strong> Chaves convertidas para mai√∫scula conforme padr√£o AT';
                            qrContentDiv.appendChild(normalizationIndicator);
                        }
                    } else if (normalizationIndicator) {
                        normalizationIndicator.remove();
                    }
                    
                    successDiv.classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                } else {
                    document.getElementById('errorMessage').textContent = content;
                    errorDiv.classList.remove('hidden');
                    successDiv.classList.add('hidden');
                }
            }

            copyToClipboard() {
                const content = document.getElementById('qrContent').textContent;
                navigator.clipboard.writeText(content).then(() => {
                    this.log('Conte√∫do copiado para a √°rea de transfer√™ncia', 'success');
                });
            }

            downloadResult() {
                const content = document.getElementById('qrContent').textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'qr-code-content.txt';
                a.click();
                URL.revokeObjectURL(url);
                this.log('Resultado baixado como arquivo', 'success');
            }

            clearLog() {
                const debugLog = document.getElementById('debugLog');
                debugLog.innerHTML = '<div class="text-gray-600">[INFO] Log limpo</div>';
            }

            exportLog() {
                const debugLog = document.getElementById('debugLog');
                const content = debugLog.textContent;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'debug-log.txt';
                a.click();
                URL.revokeObjectURL(url);
                this.log('Log exportado como arquivo', 'success');
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('debugLog');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                
                let icon = '';
                let colorClass = '';
                
                switch (type) {
                    case 'success':
                        icon = '‚úÖ';
                        colorClass = 'text-green-600';
                        break;
                    case 'error':
                        icon = '‚ùå';
                        colorClass = 'text-red-600';
                        break;
                    case 'warning':
                        icon = '‚ö†Ô∏è';
                        colorClass = 'text-yellow-600';
                        break;
                    default:
                        icon = '‚ÑπÔ∏è';
                        colorClass = 'text-blue-600';
                }
                
                logEntry.className = `log-entry ${colorClass} text-sm font-mono`;
                logEntry.textContent = `${timestamp} [${type.toUpperCase()}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Manter apenas os √∫ltimos 100 logs
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
        }

        // Initialize scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new JSQRScanner();
        });
    </script>
</body>
</html>